{
  "$schema": "./schema.json",
  "id": "ENT018",
  "name": "Conversation",
  "description": "Multi-agent conversation session where humans and AI agents collaborate on strategic discussions",
  "table": "Conversations",
  "status": "implemented",
  "created_at": "2026-01-17",
  "updated_at": "2026-01-17",

  "fields": [
    {
      "name": "OrganizationId",
      "type": "Guid",
      "nullable": false,
      "description": "Organization this conversation belongs to (multi-tenancy)"
    },
    {
      "name": "Title",
      "type": "string",
      "nullable": false,
      "max_length": 255,
      "description": "Title of the conversation (e.g., 'Q4 Strategy Review')"
    },
    {
      "name": "Mode",
      "type": "string",
      "nullable": false,
      "max_length": 20,
      "default": "on-demand",
      "description": "Conversation mode: 'on-demand', 'moderated', 'round-robin', 'free'",
      "enum": ["on-demand", "moderated", "round-robin", "free"]
    },
    {
      "name": "Status",
      "type": "string",
      "nullable": false,
      "max_length": 20,
      "default": "active",
      "description": "Conversation status: 'active', 'paused', 'archived'",
      "enum": ["active", "paused", "archived"]
    },
    {
      "name": "CreatedByUserId",
      "type": "Guid",
      "nullable": false,
      "description": "User who created the conversation"
    },
    {
      "name": "TotalTokens",
      "type": "bigint",
      "nullable": false,
      "default": 0,
      "description": "Total tokens consumed in this conversation"
    },
    {
      "name": "TotalCostCents",
      "type": "int",
      "nullable": false,
      "default": 0,
      "description": "Total cost in cents for AI usage"
    },
    {
      "name": "MessageCount",
      "type": "int",
      "nullable": false,
      "default": 0,
      "description": "Total number of messages in the conversation"
    },
    {
      "name": "AiResponseCount",
      "type": "int",
      "nullable": false,
      "default": 0,
      "description": "Number of AI-generated responses"
    },
    {
      "name": "MaxTurns",
      "type": "int",
      "nullable": true,
      "description": "Optional limit on conversation turns"
    },
    {
      "name": "MaxTokens",
      "type": "bigint",
      "nullable": true,
      "description": "Optional limit on total tokens"
    },
    {
      "name": "LastMessageAt",
      "type": "DateTime",
      "nullable": true,
      "description": "Timestamp of the most recent message"
    },
    {
      "name": "StartedAt",
      "type": "DateTime",
      "nullable": false,
      "description": "When the conversation was started"
    }
  ],

  "validation_rules": [
    {
      "id": "R-CNV-001",
      "field": "Title",
      "rule": "Required, 1-255 characters",
      "error_code": "TITLE_REQUIRED",
      "error_message": "Conversation title is required"
    },
    {
      "id": "R-CNV-002",
      "field": "Mode",
      "rule": "Must be one of: on-demand, moderated, round-robin, free",
      "error_code": "INVALID_MODE",
      "error_message": "Invalid conversation mode"
    },
    {
      "id": "R-CNV-003",
      "rule": "Conversation must have at least one participant",
      "error_code": "NO_PARTICIPANTS",
      "error_message": "Conversation must have at least one participant"
    }
  ],

  "relationships": [
    {
      "type": "many-to-one",
      "entity": "ENT002",
      "foreign_key": "OrganizationId",
      "navigation": "Organization",
      "description": "Organization that owns this conversation"
    },
    {
      "type": "many-to-one",
      "entity": "ENT001",
      "foreign_key": "CreatedByUserId",
      "navigation": "CreatedByUser",
      "description": "User who created the conversation"
    },
    {
      "type": "one-to-many",
      "entity": "ENT019",
      "inverse_key": "ConversationId",
      "navigation": "Messages",
      "description": "Messages in this conversation"
    },
    {
      "type": "one-to-many",
      "entity": "ENT020",
      "inverse_key": "ConversationId",
      "navigation": "Participants",
      "description": "Participants in this conversation"
    }
  ],

  "indexes": [
    {
      "name": "IX_Conversations_OrganizationId",
      "columns": ["OrganizationId"]
    },
    {
      "name": "IX_Conversations_OrganizationId_Status",
      "columns": ["OrganizationId", "Status"]
    },
    {
      "name": "IX_Conversations_CreatedByUserId",
      "columns": ["CreatedByUserId"]
    },
    {
      "name": "IX_Conversations_LastMessageAt",
      "columns": ["LastMessageAt"],
      "descending": true
    }
  ],

  "api_representation": {
    "dto_name": "ConversationDto",
    "include_fields": ["Id", "Title", "Mode", "Status", "TotalTokens", "TotalCostCents", "MessageCount", "AiResponseCount", "LastMessageAt", "StartedAt", "CreatedAt", "UpdatedAt"],
    "exclude_fields": [],
    "computed_fields": [
      {
        "name": "Participants",
        "type": "ParticipantDto[]",
        "computation": "Load from Participants navigation"
      },
      {
        "name": "TotalCost",
        "type": "decimal",
        "computation": "TotalCostCents / 100.0"
      },
      {
        "name": "Duration",
        "type": "TimeSpan",
        "computation": "LastMessageAt - StartedAt"
      }
    ]
  },

  "audit_requirements": {
    "log_create": true,
    "log_update": true,
    "log_delete": true,
    "sensitive_fields": []
  },

  "code_location": {
    "entity": "orbitos-api/src/OrbitOS.Domain/Entities/Conversation.cs",
    "dto": "orbitos-api/src/OrbitOS.Api/Controllers/ConversationsController.cs",
    "frontend_type": "orbitos-web/app/types/ai-agents.ts"
  }
}
